language: python

python:
  - "3.5"

before_install:
  - sudo mkdir -p /downloads
  - sudo chmod a+rw /downloads
  - curl -L http://sourceforge.net/projects/pyqt/files/sip/sip-4.18.1/sip-4.18.1.tar.gz -o /downloads/sip.tar.gz
  - curl -L http://sourceforge.net/projects/pyqt/files/PyQt4/PyQt-4.11.4/PyQt-x11-gpl-4.11.4.tar.gz -o /downloads/pyqt4.tar.gz
  # Builds
  - sudo mkdir -p /builds
  - sudo chmod a+rw /builds

install:
  - "sudo apt-get update"
  - "sudo apt-get install -y libqt4-dev"
  - "sudo apt-get install -y liblua5.1 libjpeg8-dev zlib1g-dev"
  - pushd /builds
  # SIP
  - tar xzf /downloads/sip.tar.gz --keep-newer-files
  - pushd sip-4.18.1
  - python configure.py
  - make
  - sudo make install
  - popd
  # PyQt4
  - tar xzf /downloads/pyqt4.tar.gz --keep-newer-files
  - pushd PyQt-x11-gpl-4.11.4
  - python configure.py -c --confirm-license --no-designer-plugin -e QtCore -e QtGui -e QtTest -e QtNetwork -e QtWebKit
  - make
  - sudo make install
  - popd
  - popd
  - "pip install cx_Freeze"
  - "pip install python-coveralls"
  - "pip install -r requirements.txt --trusted-host content.faforever.com"
  - curl -s https://api.github.com/repos/FAForever/uid/releases/latest | jq -r '.assets[] | select(.name == "faf-uid") | .browser_download_url' | wget -i - -O ./lib/faf-uid


before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"

script:
  - export PYTEST_QT_API=pyqt4v2
  - python2 runtests.py -xs --cov src --cov-report term-missing

after_success:
  - coveralls
